[← Getting Started](getting-started.md) · [Back to README](../README.md) · [API Reference →](api.md)

# Architecture

StuffTracker uses **Vertical Slice Architecture** on the backend and **feature-based modules** on the frontend. Each feature owns its complete stack — from HTTP endpoint to database query.

## Backend Structure

```
backend/src/StuffTracker.Api/
├── Domain/                         # Core entities — pure C#, no framework deps
│   ├── Item.cs
│   ├── StorageLocation.cs
│   └── User.cs
│
├── Application/                    # Cross-cutting application services
│
├── Infrastructure/
│   ├── Persistence/
│   │   ├── AppDbContext.cs         # EF Core DbContext
│   │   ├── Migrations/             # Generated by dotnet-ef, never edit manually
│   │   └── Repositories/          # ILocationRepository, IItemRepository, etc.
│   └── Telegram/                   # initData validation, bot client
│
├── Common/
│   ├── BaseEndpoint.cs             # FastEndpoints base — provides GetUserId()
│   ├── ApiErrorResponse.cs         # Shared error response shape
│   └── Middleware/                 # Auth middleware, exception handler
│
└── Features/                       # One folder per use-case (vertical slices)
    ├── Auth/GetCurrentUser/
    ├── Items/
    │   ├── CreateItem/             # Endpoint + Request + Validator
    │   ├── GetItem/
    │   ├── UpdateItem/
    │   ├── DeleteItem/
    │   ├── MoveItem/
    │   └── Shared/                 # ItemResponse, ItemDetailResponse (shared DTOs)
    ├── Locations/
    │   ├── CreateLocation/
    │   ├── GetLocation/
    │   ├── GetTopLevelLocations/
    │   ├── GetLocationTree/
    │   ├── UpdateLocation/
    │   ├── DeleteLocation/
    │   ├── MoveLocation/
    │   └── Shared/                 # LocationResponse (shared DTO)
    └── Search/SearchItems/
```

### What a Slice Contains

Each slice folder (e.g. `CreateLocation/`) contains:

| File | Purpose |
|------|---------|
| `*Endpoint.cs` | FastEndpoints handler — HTTP method, route, response logic |
| `*Request.cs` | Input DTO (deserialized from body or query string) |
| `*Validator.cs` | FluentValidation rules for the request |

### Dependency Rules

```
Domain         ──► nothing (pure business logic)
Application    ──► Domain
Infrastructure ──► Domain + Application (implements interfaces)
Features       ──► Domain + Infrastructure + Common
Common         ──► Domain (minimal)
```

- ✅ Feature slices use Domain entities directly
- ✅ Feature slices inject repository interfaces via DI
- ✅ Sibling `Shared/` DTOs are shared within one feature group (e.g. all Location slices)
- ❌ Feature slices must NOT import from other feature slices
- ❌ Domain must NOT reference Infrastructure, Features, or Common

---

## Frontend Structure

```
frontend/src/app/
├── core/
│   ├── api/                        # HTTP services (LocationService, ItemService, etc.)
│   ├── auth/                       # Auth state, guards, interceptors
│   └── navigation.service.ts
│
├── telegram/                       # @twa-dev/sdk wrapper — always use this, never window.Telegram
│
├── shared/
│   └── components/                 # Reusable UI components
│       ├── breadcrumbs/            # Hierarchical navigation breadcrumbs
│       ├── delete-confirmation/    # Confirmation dialog for destructive actions
│       ├── empty-state/            # Empty state with icon, message, action
│       ├── error-toast/            # Toast notifications (error, success, warning, info)
│       ├── item-card/              # Compact item display card
│       ├── item-list/              # Item list container
│       ├── loading-spinner/        # Loading indicator (small/medium/large)
│       ├── location-autocomplete/  # Text input with filtered dropdown for location selection
│       ├── location-card/          # Compact location display card
│       ├── location-picker/        # Bottom-sheet tree picker for location filter
│       └── search-result-item/     # Search result display
│
└── features/
    ├── home/                       # Root location list
    ├── item/                       # Item detail, add/edit form
    ├── location/                   # Location detail, form, move modal
    └── search/                     # Search results
```

### Frontend Dependency Rules

- ✅ Features inject services from `core/`
- ✅ Features use shared components from `shared/`
- ✅ Telegram SDK accessed only via `telegram/` wrapper
- ❌ Features must NOT import from other features
- ❌ `shared/` and `core/` must NOT import from `features/`

### Angular — Zoneless Change Detection

The frontend runs in **zoneless mode** (`provideZonelessChangeDetection()` — no `zone.js`). Change detection is driven entirely by signals and explicit `markDirty` calls.

Rules:
- ✅ Every component **must** declare `changeDetection: ChangeDetectionStrategy.OnPush`
- ✅ Use `signal()`, `computed()`, `effect()` for reactive state
- ✅ Use `toObservable(signal)` + `switchMap` when a signal change should trigger an HTTP request (prevents duplicate in-flight requests on rapid changes)
- ✅ Use `takeUntilDestroyed(destroyRef)` for all Observable subscriptions
- ❌ `ChangeDetectionStrategy.Default` — incompatible with zoneless, will not detect changes
- ❌ `effect(() => { observable.subscribe() })` — creates multiple overlapping subscriptions; use `toObservable + switchMap` instead
- ❌ Manual `Subject<void>` + `ngOnDestroy` teardown — replace with `takeUntilDestroyed`

---

## Key Patterns

### Authentication Flow

```
[Telegram App] ──initData──► [Angular] ──X-Telegram-Init-Data header──► [API Middleware]
                                                                              │
                                                              HMAC validate against BotToken
                                                                              │
                                                              Inject TelegramUser into HttpContext
                                                                              │
                                                              BaseEndpoint.GetUserId() ──► userId
```

In `DevMode`, the middleware injects a fake user — no real initData required.

### Location Hierarchy

Locations are stored with a `ParentId` foreign key and a `BreadcrumbIds` array (denormalized path from root). This allows O(1) breadcrumb display without recursive queries.

```
Room (id: A, parentId: null,  breadcrumbIds: [A])
  └── Shelf (id: B, parentId: A, breadcrumbIds: [A, B])
        └── Box  (id: C, parentId: B, breadcrumbIds: [A, B, C])
```

### EF Core — NoTracking by Default

All read queries use `.AsNoTracking()`. Tracked queries are only used when explicitly calling `SaveChanges()`.

```csharp
// ✅ Reads
return await _db.Locations
    .AsNoTracking()
    .Where(l => l.UserId == userId)
    .ToListAsync(ct);

// ✅ Writes — track explicitly
var location = await _db.Locations.FindAsync(id, ct); // tracked
location.Name = req.Name;
await _db.SaveChangesAsync(ct);
```

---

## See Also

- [API Reference](api.md) — all endpoints
- [Getting Started](getting-started.md) — running locally
- [Configuration](configuration.md) — environment variables
